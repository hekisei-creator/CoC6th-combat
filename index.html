<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>クトゥルフ神話TRPG 銃火器戦闘サポーター v7.1</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital@1&family=Noto+Serif+JP:wght@400;700&family=Playfair+Display:wght@700&family=Share+Tech+Mono&family=Special+Elite&family=Oswald:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* ======================================== */
        /* 共通スタイル (レイアウト)                */
        /* ======================================== */
        :root {
            --base-bg: #f0f0f0;
            --text-color: #333;
            --container-bg: #fff;
            --header-bg: #f8f8f8;
            --list-bg: #e9e9e9;
            --item-bg: #fff;
            --border-color: #ddd;
            --accent-color: #3498db;
            --font-main: 'Helvetica', 'Arial', sans-serif;
        }

        body {
            background-color: var(--base-bg);
            color: var(--text-color);
            font-family: var(--font-main);
            margin: 0;
            padding: 20px;
            transition: background-color 0.5s, color 0.5s;
        }

        .container {
            max-width: 800px;
            margin-left: 0;
            margin-right: auto;
            background-color: var(--container-bg);
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            transition: background-color 0.5s, border-color 0.5s;
        }

        header {
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 20px;
            margin-bottom: 20px;
            background-color: var(--header-bg);
        }

        h1 { margin-top: 0; transition: color 0.5s; }
        h2 { text-align: left; margin: 0 0 15px 0; transition: color 0.5s; flex-grow: 1; }

        .controls-wrapper { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
        .top-controls { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .add-character-form { display: flex; align-items: center; flex-wrap: wrap; gap: 10px; }
        .char-type-selector label { margin-right: 10px; }

        input[type="text"], input[type="number"], button, select {
            padding: 8px;
            font-family: inherit;
            font-size: 1em;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }
        #character-initiative { width: 60px; text-align: center; }
        
        button { cursor: pointer; }
        .combat-rounds { display: flex; flex-direction: column; gap: 20px; position: relative; }
        .dex-cycle { background-color: var(--container-bg); border: 1px solid var(--border-color); flex: 1; padding: 15px; }
        
        .marker-cell, .marker-cell-header {
            width: 30px;
            min-width: 30px;
            border-right: 1px dashed var(--border-color);
            flex-shrink: 0;
        }
        .dex-cycle-header { display: flex; align-items: center; padding-left: 30px;}
        #turn-marker {
            position: absolute;
            left: 0;
            top: 20px;
            width: 30px;
            text-align: center;
            font-size: 1.5em;
            color: var(--accent-color);
            cursor: grab;
            user-select: none;
            z-index: 10;
        }
        #turn-marker:active { cursor: grabbing; }

        .character-list { list-style: none; padding: 5px; margin: 0; min-height: 150px; background-color: var(--list-bg); border-radius: 4px; }
        
        .character-list:empty::before {
            content: attr(data-empty-text, "--- NO DATA ---");
            display: block;
            text-align: center;
            color: var(--text-color);
            opacity: 0.5;
            padding: 50px 0;
            font-size: 1.2em;
            font-style: italic;
            background-image: linear-gradient(to top left, transparent calc(50% - 1px), var(--border-color) 50%, transparent calc(50% + 1px));
            background-size: 100% 100%;
        }

        .character-item {
            display: flex;
            align-items: stretch;
            justify-content: space-between;
            background-color: var(--item-bg);
            border: 1px solid var(--border-color);
            padding: 0;
            margin: 8px;
            border-radius: 4px;
            cursor: grab;
            font-size: 1.2em;
            font-weight: bold;
            user-select: none;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .character-info { display: flex; align-items: center; gap: 15px; flex-grow: 1; padding: 12px 15px; }
        .char-initiative { font-size: 1.1em; font-weight: bold; color: var(--accent-color); min-width: 3ch; text-align: center; }
        .char-icon { width: 1.2em; height: 1.2em; flex-shrink: 0; display: inline-flex; justify-content: center; align-items: center; box-sizing: border-box; }
        
        .item-controls { display: flex; align-items: center; padding: 0 10px; }

        .duplicate-btn, .delete-btn {
            background: transparent; border: none; font-size: 1.5em; color: #aaa;
            cursor: pointer; padding: 0 5px; opacity: 0.5; transition: opacity 0.3s, color 0.3s;
        }
        .character-item:hover .duplicate-btn, .character-item:hover .delete-btn { opacity: 1; }
        .duplicate-btn:hover { color: #3498db; }
        .delete-btn:hover { color: #f00; }
        
        #capture-area.is-exporting #turn-marker { display: none; }

        #reset-btn { background-color: #e74c3c; color: white; border-color: #c0392b; }
        #capture-btn { background-color: #28a745; color: white; border-color: #218838; }

        .how-to-use { margin-bottom: 20px; border: 1px solid var(--border-color); border-radius: 4px; }
        .how-to-use summary { padding: 10px 15px; font-weight: bold; cursor: pointer; outline: none; background-color: var(--list-bg); }
        .how-to-use-content { padding: 0 15px 15px 15px; background-color: var(--item-bg); border-top: 1px solid var(--border-color); }
        .how-to-use-content h4 { margin: 15px 0 5px 0; }
        .how-to-use-content ul { padding-left: 20px; margin: 0; }
        

    </style>
</head>
<body class="theme-default">
    <div class="container">
        <header>
            <h1 id="main-title">COMBAT INITIATIVE</h1>
            <details class="how-to-use">
                <summary id="how-to-use-summary">How to Use</summary>
                <div class="how-to-use-content" id="how-to-use-content"></div>
            </details>
            <div class="controls-wrapper">
                <div class="top-controls">
                    <div class="theme-switcher-wrapper">
                        <label for="theme-switcher" id="theme-label">スキン: </label>
                        <select id="theme-switcher">
                            <option value="theme-default">デフォルト</option>
                            <option value="theme-fbi">FBI（捜査班）</option>
                            <option value="theme-cyber">サイバー</option>
                            <option value="theme-classic">クラシック</option>
                            <option value="theme-japanese">和風</option>
                            <option value="theme-gothic">ゴシック</option>
                            <option value="theme-mountain">登山（狂気山脈）</option>
                            <option value="theme-mono">モノクロ</option>
                        </select>
                    </div>
                    <button id="reset-btn">全削除</button>
                    <button id="capture-btn">画像出力</button>
                </div>
                <div class="add-character-form">
                    <div class="char-type-selector">
                        <input type="radio" id="type-investigator" name="char-type" value="investigator" checked>
                        <label for="type-investigator" id="label-investigator">探索者</label>
                        <input type="radio" id="type-npc" name="char-type" value="npc">
                        <label for="type-npc" id="label-npc">NPC</label>
                        <input type="radio" id="type-enemy" name="char-type" value="enemy">
                        <label for="type-enemy" id="label-enemy">エネミー</label>
                    </div>
                    <input type="text" id="character-name" placeholder="コマの名前">
                    <input type="text" id="character-initiative" placeholder="INIT">
                    <input type="color" id="character-color" value="#000000">
                    <button id="add-character-btn">追加</button>
                </div>
            </div>
        </header>

        <main class="combat-rounds" id="capture-area">
            <div id="turn-marker">▶</div>
            <div class="dex-cycle" id="dex-cycle-1">
                <div class="dex-cycle-header">
                    <div class="marker-cell-header"></div>
                    <h2 id="dex-cycle-1-title">第1DEXサイクル (銃火器先攻)</h2>
                </div>
                <ul class="character-list" id="list-1"></ul>
            </div>
            <div class="dex-cycle" id="dex-cycle-2">
                <div class="dex-cycle-header">
                    <div class="marker-cell-header"></div>
                    <h2 id="dex-cycle-2-title">第2DEXサイクル (通常行動)</h2>
                </div>
                <ul class="character-list" id="list-2"></ul>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- UIテキストの定義 ---
            const uiText = {
                default: { mainTitle: "COMBAT INITIATIVE", themeLabel: "スキン: ", resetBtn: "全削除", captureBtn: "画像出力", labelInvestigator: "探索者", labelNpc: "NPC", labelEnemy: "エネミー", addBtn: "追加", namePlaceholder: "コマの名前", initPlaceholder: "INIT", dex1Title: "第1DEXサイクル (銃火器先攻)", dex2Title: "第2DEXサイクル (通常行動)", emptyData: "--- NO DATA ---", howToUseTitle: "How to Use", howToUseContent: `<h4>コマの追加</h4><ul><li>名前、INIT(イニシアチブ値)、種類、イメージカラーを設定して「追加」ボタンを押します。</li><li>INITには数字のほか「？」も入力可能です。</li></ul><h4>イニシアチブ管理</h4><ul><li>コマはドラッグ＆ドロップで自由に行動順を並べ替えられます。</li><li>銃火器先攻を行うコマは「第1DEXサイクル」へ移動させてください。（基本ルールブックp65参照）</li><li>左の「▶」マーカーをドラッグして現在の手番を示すことができます。</li></ul><h4>管理機能</h4><ul><li>各コマの右の「×」で個別削除、「全削除」で全てを削除します。</li><li>「❐」ボタンでコマを複製できます。</li><li>「画像出力」で戦闘ラウンド部分をPNG画像として保存できます。（「▶」マーカーは出力されません）</li></ul>` },
                japanese: { mainTitle: "戦闘序列", themeLabel: "意匠: ", resetBtn: "全消去", captureBtn: "絵図出力", labelInvestigator: "探索者", labelNpc: "NPC", labelEnemy: "敵対者", addBtn: "追加", namePlaceholder: "コマの名前", initPlaceholder: "行動値", dex1Title: "壱之巡（銃火器先攻）", dex2Title: "弐之巡（通常行動）", emptyData: "該当者なし", howToUseTitle: "使用方法", howToUseContent: `<h4>コマの追加</h4><ul><li>名前、行動値、種別、配色を指定し「追加」を押してください。</li><li>行動値には数字のほか「？」も入力可能です。</li></ul><h4>行動順の管理</h4><ul><li>各コマはドラッグ＆ドロップで自由に行動順を並べ替えられます。</li><li>銃火器先攻を行うコマは「壱之巡」へ移動させてください。（基本ルールブックp65参照）</li><li>左の「▶」印をドラッグして現在の手番を示すことができます。</li></ul><h4>管理機能</h4><ul><li>各コマの右の「×」で個別消去、「全消去」で全てを消去します。</li><li>「❐」ボタンでコマを複製できます。</li><li>「絵図出力」で戦闘序列の部分をPNG画像として保存できます。（「▶」印は出力されません）</li></ul>` },
                fbi: { mainTitle: "FBI TACTICAL ORDER", themeLabel: "THEME: ", resetBtn: "CLEAR ALL", captureBtn: "EXPORT IMAGE", labelInvestigator: "AGENT", labelNpc: "CIVILIAN", labelEnemy: "HOSTILE", addBtn: "ADD", namePlaceholder: "NAME", initPlaceholder: "INIT", dex1Title: "CYCLE 1 (FIREARMS PRIORITY)", dex2Title: "CYCLE 2 (STANDARD ACTIONS)", emptyData: "--- NO ENTRIES ---", howToUseTitle: "OPERATIONAL GUIDANCE", howToUseContent: `<h4>ADD ENTRY</h4><ul><li>Enter name, INIT (Initiative value), type, and select a color, then click "ADD".</li><li>INIT field accepts numbers or "?".</li></ul><h4>MANAGE INITIATIVE</h4><ul><li>Entries can be reordered by drag & drop.</li><li>Move firearm-wielding characters to "CYCLE 1". (Refer to the basic rulebook, p. 65)</li><li>Drag the "▶" marker on the left to indicate the current turn.</li></ul><h4>CONTROL FUNCTIONS</h4><ul><li>Click "×" to delete individual entries, or "CLEAR ALL" to remove all.</li><li>Click "❐" to duplicate an entry.</li><li>"EXPORT IMAGE" saves the tactical order section as a PNG image. (The "▶" marker will not be exported)</li></ul>` }
            };
            
            // --- 要素取得 ---
            const nameInput = document.getElementById('character-name');
            const initiativeInput = document.getElementById('character-initiative');
            const colorInput = document.getElementById('character-color');
            const addButton = document.getElementById('add-character-btn');
            const lists = document.querySelectorAll('.character-list');
            const themeSwitcher = document.getElementById('theme-switcher');
            const resetButton = document.getElementById('reset-btn');
            const captureButton = document.getElementById('capture-btn');
            const captureArea = document.getElementById('capture-area');
            const turnMarker = document.getElementById('turn-marker');

            let draggedItem = null;

            // --- イベントリスナー設定 ---
            addButton.addEventListener('click', () => addCharacterFromForm());
            nameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addCharacterFromForm(); });
            initiativeInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addCharacterFromForm(); });
            
            themeSwitcher.addEventListener('change', (e) => {
                const theme = e.target.value;
                document.body.className = theme;
                updateUiText(theme);
                document.querySelectorAll('.character-item').forEach(updateInitiativeDisplay);
            });
            
            resetButton.addEventListener('click', resetAll);
            captureButton.addEventListener('click', captureAndDownload);

            lists.forEach(list => {
                list.addEventListener('click', (e) => {
                    const targetItem = e.target.closest('.character-item');
                    if (!targetItem) return;
                    if (e.target.closest('.delete-btn')) { targetItem.remove(); } 
                    else if (e.target.closest('.duplicate-btn')) { duplicateCharacter(targetItem); }
                });
            });

            let isMarkerDragging = false;
            turnMarker.addEventListener('mousedown', (e) => {
                isMarkerDragging = true;
                turnMarker.style.cursor = 'grabbing';
            });
            document.addEventListener('mouseup', () => {
                isMarkerDragging = false;
                turnMarker.style.cursor = 'grab';
            });
            document.addEventListener('mousemove', (e) => {
                if (!isMarkerDragging) return;
                const rect = captureArea.getBoundingClientRect();
                let newY = e.clientY - rect.top - (turnMarker.offsetHeight / 2);
                if (newY < 0) newY = 0;
                if (newY > captureArea.offsetHeight - turnMarker.offsetHeight) { newY = captureArea.offsetHeight - turnMarker.offsetHeight; }
                turnMarker.style.top = `${newY}px`;
            });
            
            // --- 関数定義 ---
            function createCharacterElement(name, initiative, color, charType) {
                const li = document.createElement('li');
                li.className = 'character-item';
                li.draggable = true;
                li.dataset.initiative = initiative;
                li.innerHTML = `<div class="marker-cell"></div><div class="character-info"><span class="char-initiative"></span><span class="char-icon ${charType}"></span><span class="char-name">${name}</span></div><div class="item-controls"><button class="duplicate-btn">❐</button><button class="delete-btn">×</button></div>`;
                li.style.setProperty('--dynamic-color', color);
                li.querySelector('.char-name').style.color = color;
                updateInitiativeDisplay(li);
                addDragEvents(li);
                return li;
            }
            
            function addCharacterFromForm() {
                const name = nameInput.value.trim();
                let initiative = initiativeInput.value.trim();
                const color = colorInput.value;
                const charType = document.querySelector('input[name="char-type"]:checked').value;
                if (name === '') { alert('コマの名前を入力してください。'); return; }
                initiative = initiative.replace(/[０-９]/g, (s) => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
                const newCharElement = createCharacterElement(name, initiative, color, charType);
                document.getElementById('list-2').appendChild(newCharElement);
                nameInput.value = '';
                initiativeInput.value = '';
                nameInput.focus();
            }

            function duplicateCharacter(originalItem) {
                const name = originalItem.querySelector('.char-name').textContent;
                const initiative = originalItem.dataset.initiative;
                const color = originalItem.style.getPropertyValue('--dynamic-color');
                const iconSpan = originalItem.querySelector('.char-icon');
                const charType = Array.from(iconSpan.classList).find(c => c !== 'char-icon');
                const newCharElement = createCharacterElement(name, initiative, color, charType);
                originalItem.after(newCharElement);
            }

            function updateUiText(theme) {
                const themeKey = theme.replace('theme-', '');
                const textSet = uiText[themeKey] || uiText.default;
                document.getElementById('main-title').textContent = textSet.mainTitle;
                document.getElementById('theme-label').textContent = textSet.themeLabel;
                resetButton.textContent = textSet.resetBtn;
                captureButton.textContent = textSet.captureBtn;
                document.getElementById('label-investigator').textContent = textSet.labelInvestigator;
                document.getElementById('label-npc').textContent = textSet.labelNpc;
                document.getElementById('label-enemy').textContent = textSet.labelEnemy;
                addButton.textContent = textSet.addBtn;
                nameInput.placeholder = textSet.namePlaceholder;
                initiativeInput.placeholder = textSet.initPlaceholder;
                document.getElementById('dex-cycle-1-title').textContent = textSet.dex1Title;
                document.getElementById('dex-cycle-2-title').textContent = textSet.dex2Title;
                document.getElementById('how-to-use-summary').textContent = textSet.howToUseTitle;
                document.getElementById('how-to-use-content').innerHTML = textSet.howToUseContent;
                lists.forEach(list => list.dataset.emptyText = textSet.emptyData);
            }
            
            function updateInitiativeDisplay(listItem) {
                const initiativeValue = listItem.dataset.initiative;
                const displaySpan = listItem.querySelector('.char-initiative');
                if (document.body.classList.contains('theme-japanese')) {
                    displaySpan.textContent = toKanjiNumber(initiativeValue);
                } else {
                    displaySpan.textContent = initiativeValue || '-';
                }
            }
            
            function toKanjiNumber(numStr) {
                if (!numStr || isNaN(parseInt(numStr, 10))) { return numStr || '-'; }
                const num = parseInt(numStr, 10);
                if (num === 0) return '零';
                const kanjiDigits = ['', '一', '二', '三', '四', '五', '六', '七', '八', '九'];
                let result = '';
                if (num >= 10) {
                    const tens = Math.floor(num / 10);
                    result += (tens > 1 ? kanjiDigits[tens] : '') + '十';
                }
                const ones = num % 10;
                if (ones > 0) { result += kanjiDigits[ones]; }
                return result;
            }

            function resetAll() {
                if (confirm('本当にすべてのコマを削除しますか？')) {
                    lists.forEach(list => list.innerHTML = '');
                }
            }
            
            function captureAndDownload() {
                captureArea.classList.add('is-exporting');
                const computedStyle = getComputedStyle(document.body);
                let bgColor = computedStyle.backgroundColor;
                if (bgColor === 'rgba(0, 0, 0, 0)') { bgColor = '#ffffff'; }
                html2canvas(captureArea, {
                    backgroundColor: bgColor, scale: 2,
                    windowWidth: captureArea.scrollWidth, windowHeight: captureArea.scrollHeight
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = 'combat_initiative.png';
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    captureArea.classList.remove('is-exporting');
                });
            }

            function addDragEvents(item) {
                item.addEventListener('dragstart', (e) => {
                    draggedItem = item;
                    setTimeout(() => item.classList.add('dragging'), 0);
                });
                item.addEventListener('dragend', () => {
                    if(draggedItem) draggedItem.classList.remove('dragging');
                    draggedItem = null;
                });
            }

            lists.forEach(list => {
                list.addEventListener('dragover', e => {
                    e.preventDefault();
                    const afterElement = getDragAfterElement(list, e.clientY);
                    if (draggedItem) {
                        if (afterElement == null) list.appendChild(draggedItem);
                        else list.insertBefore(draggedItem, afterElement);
                    }
                });
            });

            function getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.character-item:not(.dragging)')];
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }
            
            updateUiText(themeSwitcher.value);
        });
    </script>
</body>
</html>
